-- ===========================================
-- FLEISCHPANEL + ANTI-LAG ULTRA (RINGS + UPGRADE)
-- LocalScript (cliente) - VERSÃO OTIMIZADA
-- ===========================================

-- ============= SERVICES / BASE =============
local Players            = game:GetService("Players")
local ReplicatedStorage  = game:GetService("ReplicatedStorage")
local TweenService       = game:GetService("TweenService")
local UserInputService   = game:GetService("UserInputService")
local RunService         = game:GetService("RunService")
local CollectionService  = game:GetService("CollectionService")
local HttpService        = game:GetService("HttpService")
local Debris             = game:GetService("Debris")

local player    = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- ============= CACHE E OTIMIZAÇÕES ULTRA =============
local cache = {
    processedParts = {},
    processedPlayers = {},
    lastCleanup = 0,
    frameCount = 0,
    memoryUsage = 0,
    lastFrameTime = 0,
    frameTimes = {},
    avgFrameTime = 0,
    performanceMode = "ULTRA",
    skipFrames = 0,
    maxSkipFrames = 3
}

-- ============= CONFIGURAÇÕES ULTRA PERFORMANCE =============
local ULTRA_PERFORMANCE = {
    MAX_FRAME_TIME = 1/60, -- 60 FPS mínimo
    MEMORY_CLEANUP_INTERVAL = 2, -- Limpeza a cada 2 segundos
    UI_UPDATE_INTERVAL = 5, -- UI atualiza a cada 5 segundos
    ESP_UPDATE_INTERVAL = 1, -- ESP atualiza a cada 1 segundo
    WALL_SCAN_INTERVAL = 2, -- Scan de paredes a cada 2 segundos
    STRIP_INTERVAL = 3, -- Strip de skins a cada 3 segundos
    MAX_PROCESSED_PER_FRAME = 10, -- Máximo de objetos processados por frame
    ENABLE_FRAME_SKIPPING = true, -- Pular frames quando necessário
    ENABLE_ADAPTIVE_PERFORMANCE = true -- Ajustar performance baseado no FPS
}

-- ============= REMOTE / COMANDOS ===========
local remote = ReplicatedStorage
    :WaitForChild("Packages")
    :WaitForChild("Net")
    :WaitForChild("RE/AdminPanelService/ExecuteCommand")

local comandos = { "ragdoll","balloon","jail","morph","jumpscare","inverse","tiny","rocket" }

local function executarComandos(playerName)
    if not playerName or playerName == "" then return end
    task.spawn(function()
        for _, cmd in ipairs(comandos) do
            local nomeConsulta = playerName
            if type(nomeConsulta) == "string" and string.sub(nomeConsulta, 1, 1) == "@" then
                nomeConsulta = string.sub(nomeConsulta, 2)
            end
            local alvo = Players:FindFirstChild(nomeConsulta)
            if alvo then
                if cmd == "rocket" then task.wait(3) end
                remote:FireServer(alvo, cmd)
            end
            task.wait(0.25)
        end
    end)
end

-- ============= UI: FLEISCHPANEL ============
if playerGui:FindFirstChild("CmdUI") then
    playerGui.CmdUI:Destroy()
end

local screenGui = Instance.new("ScreenGui")
screenGui.Name = "CmdUI"
screenGui.ResetOnSpawn = false
screenGui.DisplayOrder = 999
screenGui.Parent = playerGui

local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 200, 0, 250)
frame.Position = UDim2.new(1, -220, 0.5, 100)
frame.BackgroundColor3 = Color3.fromRGB(14, 17, 22)
frame.BorderSizePixel = 0
frame.Active = true
frame.Draggable = true
frame.Parent = screenGui

local corner = Instance.new("UICorner")
corner.CornerRadius = UDim.new(0, 15)
corner.Parent = frame

local frameStroke = Instance.new("UIStroke")
frameStroke.Thickness = 1
frameStroke.Color = Color3.fromRGB(70, 70, 100)
frameStroke.Transparency = 0.3
frameStroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
frameStroke.Parent = frame

local header = Instance.new("Frame")
header.Size = UDim2.new(1, 0, 0, 40)
header.BackgroundColor3 = Color3.fromRGB(14, 17, 22)
header.BorderSizePixel = 0
header.Parent = frame

local headerCorner = Instance.new("UICorner")
headerCorner.CornerRadius = UDim.new(0, 15)
headerCorner.Parent = header

local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, -20, 1, 0)
title.Position = UDim2.new(0, 10, 0, 0)
title.BackgroundTransparency = 1
title.Text = "FleischPanel"
title.TextColor3 = Color3.fromRGB(255, 255, 255)
title.Font = Enum.Font.GothamBold
title.TextSize = 18
title.TextXAlignment = Enum.TextXAlignment.Left
title.Parent = header

-- Minimizar com CTRL
local isMinimized = false
local function toggleMinimize()
    isMinimized = not isMinimized
    frame.Visible = not isMinimized
end

UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    if input.KeyCode == Enum.KeyCode.LeftControl or input.KeyCode == Enum.KeyCode.RightControl then
        toggleMinimize()
    end
end)

-- Lista de jogadores
local scrolling = Instance.new("ScrollingFrame")
scrolling.Size = UDim2.new(1, -20, 1, -60)
scrolling.Position = UDim2.new(0, 10, 0, 60)
scrolling.BackgroundColor3 = Color3.fromRGB(14, 17, 22)
scrolling.BorderSizePixel = 0
scrolling.ScrollBarThickness = 8
scrolling.ScrollBarImageColor3 = Color3.fromRGB(100, 100, 120)
scrolling.CanvasSize = UDim2.new(0, 0, 0, 0)
scrolling.AutomaticCanvasSize = Enum.AutomaticSize.Y
scrolling.Parent = frame

local scrollCorner = Instance.new("UICorner")
scrollCorner.CornerRadius = UDim.new(0, 10)
scrollCorner.Parent = scrolling

local listLayout = Instance.new("UIListLayout")
listLayout.Parent = scrolling
listLayout.Padding = UDim.new(0, 8)
listLayout.SortOrder = Enum.SortOrder.LayoutOrder

local padding = Instance.new("UIPadding")
padding.PaddingTop = UDim.new(0, 8)
padding.PaddingBottom = UDim.new(0, 8)
padding.PaddingLeft = UDim.new(0, 8)
padding.PaddingRight = UDim.new(0, 8)
padding.Parent = scrolling

local function criarBotao(playerObj)
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(1, -16, 0, 40)
    btn.BackgroundColor3 = Color3.fromRGB(14, 17, 22)
    btn.BorderSizePixel = 0
    btn.AutoButtonColor = false
    btn.Text = ""
    btn.Parent = scrolling

    local cornerBtn = Instance.new("UICorner")
    cornerBtn.CornerRadius = UDim.new(0, 10)
    cornerBtn.Parent = btn

    local btnStroke = Instance.new("UIStroke")
    btnStroke.Thickness = 1
    btnStroke.Color = Color3.fromRGB(70, 70, 100)
    btnStroke.Transparency = 0.4
    btnStroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
    btnStroke.Parent = btn

    local playerNameLbl = Instance.new("TextLabel")
    playerNameLbl.Size = UDim2.new(1, -50, 1, 0)
    playerNameLbl.Position = UDim2.new(0, 10, 0, 0)
    playerNameLbl.BackgroundTransparency = 1
    playerNameLbl.Text = playerObj.Name
    playerNameLbl.TextColor3 = Color3.fromRGB(255, 255, 255)
    playerNameLbl.Font = Enum.Font.GothamBold
    playerNameLbl.TextSize = 14
    playerNameLbl.TextXAlignment = Enum.TextXAlignment.Left
    playerNameLbl.Parent = btn

    local hoverTween = TweenService:Create(btn, TweenInfo.new(0.15, Enum.EasingStyle.Sine, Enum.EasingDirection.Out), { BackgroundColor3 = Color3.fromRGB(24, 28, 36) })
    local unhoverTween = TweenService:Create(btn, TweenInfo.new(0.2, Enum.EasingStyle.Sine, Enum.EasingDirection.Out), { BackgroundColor3 = Color3.fromRGB(14, 17, 22) })
    btn.MouseEnter:Connect(function() hoverTween:Play() end)
    btn.MouseLeave:Connect(function() unhoverTween:Play() end)

    btn.MouseButton1Click:Connect(function()
        executarComandos(playerObj.Name)
    end)
end

local function atualizarLista()
    for _, child in ipairs(scrolling:GetChildren()) do
        if child:IsA("TextButton") then child:Destroy() end
    end
    for _, p in ipairs(Players:GetPlayers()) do
        if p ~= player then criarBotao(p) end
    end
end

-- ===== UI ULTRA OTIMIZADA =====
local lastUIUpdate = 0
local uiUpdateInterval = ULTRA_PERFORMANCE.UI_UPDATE_INTERVAL

task.spawn(function()
    while screenGui.Parent do
        local currentTime = tick()
        if currentTime - lastUIUpdate >= uiUpdateInterval then
            atualizarLista()
            lastUIUpdate = currentTime
        end
        task.wait(1) -- Verificar a cada segundo se precisa atualizar
    end
end)
atualizarLista()

-- ============= ANTI-LAG (UPGRADE + RINGS) =============
-- CONFIG
local ENABLE_STRIP_SKINS      = true
local ENABLE_NO_WALLS         = true
local ENABLE_BRAINHOT_ESP     = true
local ENABLE_PLAYER_HIGHLIGHT = true      -- highlight vermelho
local ENABLE_PLAYER_RING      = true      -- anel/círculo vermelho no chão
local BRAINHOT_LIMITE         = 1_000_000

-- Palavras-chave de “paredes”
local WALL_KEYWORDS        = {"wall","parede","barrier","invisible","barreira","colisão","block","border","gate","bar","kill","killbrick"}
local ENABLE_REMOVE_WALLS  = false
local WALL_SCAN_INTERVAL   = 1.0
local WALL_TAG             = "NoWallProcessed"

-- Cores/visual do ESP/Highlight/Ring
local BH_FILL_COLOR        = Color3.fromRGB(255, 0, 0)
local BH_OUTLINE_COLOR     = Color3.fromRGB(255, 255, 0)
local BH_FILL_TRANSP       = 0.5
local BH_OUTLINE_TRANSP    = 0.0

local RING_COLOR           = Color3.fromRGB(255, 0, 0)
local RING_TRANSP          = 0.25
local RING_RADIUS          = 3.2   -- raio do círculo
local RING_HEIGHT          = 0.1   -- espessura do cilindro

-- ===== LIGHTING / TERRAIN ULTRA OTIMIZADO =====
local function ultraLightTrim()
    local Lighting = game:GetService("Lighting")
    pcall(function()
        -- Configurações básicas de performance
        Lighting.GlobalShadows = false
        Lighting.EnvironmentSpecularScale = 0
        Lighting.EnvironmentDiffuseScale = 0
        Lighting.Brightness = 1
        Lighting.Ambient = Color3.fromRGB(127,127,127)
        Lighting.OutdoorAmbient = Color3.fromRGB(127,127,127)
        Lighting.ClockTime = 12
        Lighting.GeographicLatitude = 0
        Lighting.ExposureCompensation = 0
        
        -- Remover todos os efeitos visuais
        for _, ch in ipairs(Lighting:GetChildren()) do
            if ch:IsA("BloomEffect") or ch:IsA("SunRaysEffect") or ch:IsA("DepthOfFieldEffect")
            or ch:IsA("ColorCorrectionEffect") or ch:IsA("BlurEffect") or ch:IsA("Atmosphere")
            or ch:IsA("Sky") or ch:IsA("PostEffect") then
                pcall(function() ch:Destroy() end)
            end
        end
        
        -- Configurações de sombra otimizadas
        Lighting.ShadowSoftness = 0
        Lighting.ShadowMapSize = 0
    end)
    
    local Terrain = workspace:FindFirstChildOfClass("Terrain")
    if Terrain then
        pcall(function()
            Terrain.WaterReflectance = 0
            Terrain.WaterTransparency = 1
            Terrain.WaterWaveSize = 0
            Terrain.WaterWaveSpeed = 0
            Terrain.WaterColor = Color3.fromRGB(0,0,0)
        end)
    end
    
    -- Otimizar workspace
    pcall(function()
        workspace.CurrentCamera.CameraType = Enum.CameraType.Custom
        workspace.CurrentCamera.CameraSubject = player.Character and player.Character:FindFirstChildOfClass("Humanoid")
    end)
end
ultraLightTrim()

-- ===== SISTEMA ULTRA DE LIMPEZA DE MEMÓRIA =====
local function ultraMemoryCleanup()
    local currentTime = tick()
    if currentTime - cache.lastCleanup < ULTRA_PERFORMANCE.MEMORY_CLEANUP_INTERVAL then return end
    cache.lastCleanup = currentTime
    
    -- Limpar cache de partes processadas de forma otimizada
    local partsToRemove = {}
    for part, time in pairs(cache.processedParts) do
        if not part.Parent or currentTime - time > 20 then -- Reduzido de 30 para 20
            partsToRemove[#partsToRemove + 1] = part
        end
    end
    
    for i = 1, #partsToRemove do
        cache.processedParts[partsToRemove[i]] = nil
    end
    
    -- Limpar cache de players
    local playersToRemove = {}
    for player, time in pairs(cache.processedPlayers) do
        if not player.Parent or currentTime - time > 30 then
            playersToRemove[#playersToRemove + 1] = player
        end
    end
    
    for i = 1, #playersToRemove do
        cache.processedPlayers[playersToRemove[i]] = nil
    end
    
    -- Forçar garbage collection múltiplas vezes
    collectgarbage("collect")
    collectgarbage("collect")
    
    -- Limpar instâncias órfãs de forma otimizada
    local descendants = workspace:GetDescendants()
    local orphanedObjects = {}
    for i = 1, #descendants do
        local obj = descendants[i]
        if obj:IsA("BasePart") and not obj.Parent then
            orphanedObjects[#orphanedObjects + 1] = obj
        end
    end
    
    for i = 1, #orphanedObjects do
        pcall(function() orphanedObjects[i]:Destroy() end)
    end
    
    -- Limpar frame times antigos
    if #cache.frameTimes > 60 then
        for i = 1, #cache.frameTimes - 30 do
            cache.frameTimes[i] = nil
        end
    end
end

-- ===== SISTEMA DE MONITORAMENTO DE PERFORMANCE =====
local function updatePerformanceMetrics()
    local currentTime = tick()
    local frameTime = currentTime - cache.lastFrameTime
    cache.lastFrameTime = currentTime
    
    cache.frameTimes[#cache.frameTimes + 1] = frameTime
    
    -- Calcular FPS médio
    if #cache.frameTimes > 0 then
        local totalTime = 0
        for i = 1, #cache.frameTimes do
            totalTime = totalTime + cache.frameTimes[i]
        end
        cache.avgFrameTime = totalTime / #cache.frameTimes
    end
    
    -- Ajustar performance baseado no FPS
    if ULTRA_PERFORMANCE.ENABLE_ADAPTIVE_PERFORMANCE then
        if cache.avgFrameTime > ULTRA_PERFORMANCE.MAX_FRAME_TIME then
            cache.performanceMode = "LOW"
            cache.maxSkipFrames = 5
        elseif cache.avgFrameTime < ULTRA_PERFORMANCE.MAX_FRAME_TIME * 0.5 then
            cache.performanceMode = "ULTRA"
            cache.maxSkipFrames = 1
        else
            cache.performanceMode = "NORMAL"
            cache.maxSkipFrames = 3
        end
    end
end

-- ===== UTILS =====
local function strContainsAny(s, list)
    s = string.lower(s or "")
    for _,w in ipairs(list) do
        if string.find(s, string.lower(w), 1, true) then return true end
    end
    return false
end

local function safeGetHead(char)
    return char and char:FindFirstChild("Head")
end

local function getBrainhotValue(plr)
    local leaderstats = plr:FindFirstChild("leaderstats")
    local brainhotValue = leaderstats and leaderstats:FindFirstChild("Brainhot")
    return brainhotValue and brainhotValue.Value or 0
end

-- ===== STRIP SKINS ULTRA AGRESSIVO COM FRAME LIMITING =====
local function ultraStripCharacter(character)
    if not ENABLE_STRIP_SKINS or not character then return end
    
    -- Cache para evitar processar o mesmo character múltiplas vezes
    if cache.processedPlayers[character] then return end
    cache.processedPlayers[character] = true

    -- Remover acessórios e roupas imediatamente
    local children = character:GetChildren()
    for i = 1, #children do
        local item = children[i]
        if item:IsA("Accessory") or item:IsA("Hat") or item:IsA("Shirt") or item:IsA("Pants") then 
            pcall(function() item:Destroy() end) 
        end
    end
    
    -- Processar descendentes com limite de frame
    local descendants = character:GetDescendants()
    local processedThisFrame = 0
    local maxPerFrame = ULTRA_PERFORMANCE.MAX_PROCESSED_PER_FRAME
    
    for i = 1, #descendants do
        if processedThisFrame >= maxPerFrame then break end
        
        local part = descendants[i]
        processedThisFrame = processedThisFrame + 1
        
        -- Destruir elementos visuais desnecessários
        if part:IsA("ShirtGraphic") or part:IsA("CharacterMesh") or part:IsA("Decal") 
        or part:IsA("Texture") or part:IsA("SurfaceAppearance") then
            pcall(function() part:Destroy() end)
        end
        
        -- Otimizar meshes
        if part:IsA("SpecialMesh") then
            pcall(function()
                part.TextureId = ""
                if part.MeshType == Enum.MeshType.FileMesh then 
                    part.MeshId = "" 
                end
            end)
        end
        
        -- Otimizar MeshParts
        if part:IsA("MeshPart") then
            pcall(function()
                part.TextureID = ""
                part.RenderFidelity = Enum.RenderFidelity.Performance
                part.Material = Enum.Material.Plastic
                part.Color = Color3.fromRGB(163,162,165)
                part.CastShadow = false
                part.Reflectance = 0
            end)
        end
        
        -- Otimizar BaseParts
        if part:IsA("BasePart") then
            pcall(function()
                part.Material = Enum.Material.Plastic
                part.Reflectance = 0
                part.CastShadow = false
                part.BrickColor = BrickColor.new("Medium stone grey")
                part.Color = Color3.fromRGB(163,162,165)
            end)
        end
        
        -- Destruir efeitos visuais
        if part:IsA("ParticleEmitter") or part:IsA("Fire") or part:IsA("Smoke")
        or part:IsA("Sparkles") or part:IsA("Light") or part:IsA("PointLight")
        or part:IsA("SpotLight") or part:IsA("SurfaceLight") or part:IsA("Trail") 
        or part:IsA("Beam") or part:IsA("Sound") then
            pcall(function()
                if part:IsA("ParticleEmitter") then
                    part.Rate = 0
                    part.Speed = NumberRange.new(0,0)
                    part.Enabled = false
                end
                part:Destroy()
            end)
        end
    end

    -- Otimizar cabeça
    local head = character:FindFirstChild("Head")
    if head then
        local headChildren = head:GetChildren()
        for i = 1, #headChildren do
            local item = headChildren[i]
            if item:IsA("Decal") or string.find(string.lower(item.Name), "face", 1, true) then
                pcall(function() item:Destroy() end)
            end
        end
        pcall(function()
            head.Color = Color3.fromRGB(163,162,165)
            head.Material = Enum.Material.Plastic
            head.CastShadow = false
        end)
    end

    -- Otimizar cores do corpo
    local bodyColors = character:FindFirstChildOfClass("BodyColors")
    if bodyColors then
        pcall(function()
            local stone = BrickColor.new("Medium stone grey")
            bodyColors.HeadColor = stone
            bodyColors.TorsoColor = stone
            bodyColors.LeftArmColor = stone
            bodyColors.RightArmColor = stone
            bodyColors.LeftLegColor = stone
            bodyColors.RightLegColor = stone
        end)
    end

    -- Otimizar humanoid
    local humanoid = character:FindFirstChildOfClass("Humanoid")
    if humanoid then
        local animator = humanoid:FindFirstChildOfClass("Animator")
        if animator then
            local tracks = animator:GetPlayingAnimationTracks()
            for i = 1, #tracks do
                local track = tracks[i]
                pcall(function()
                    if not tostring(track.Animation.AnimationId):find("rbxasset") then 
                        track:Stop() 
                    end
                end)
            end
        end
        pcall(function()
            local description = humanoid:FindFirstChildOfClass("HumanoidDescription")
            if description then description:Destroy() end
        end)
    end
end

local function processPlayer(plr)
    if plr ~= player then
        if plr.Character then ultraStripCharacter(plr.Character) end
        plr.CharacterAdded:Connect(function(character)
            task.wait(0.1) ultraStripCharacter(character)
            task.wait(0.5) ultraStripCharacter(character)
        end)
        plr.CharacterAppearanceLoaded:Connect(function(character) ultraStripCharacter(character) end)
    end
end
for _, p in ipairs(Players:GetPlayers()) do processPlayer(p) end
Players.PlayerAdded:Connect(processPlayer)

-- ===== NO-WALLS ULTRA OTIMIZADO =====
local lastWallScan = 0
local function ultraProcessPart(inst)
    if cache.processedParts[inst] then return end
    cache.processedParts[inst] = tick()
    
    pcall(function()
        if ENABLE_REMOVE_WALLS then 
            inst:Destroy() 
            return 
        end
        
        -- Otimizações básicas
        inst.CanCollide = false
        inst.CastShadow = false
        inst.Transparency = 1
        inst.Material = Enum.Material.Plastic
        inst.Reflectance = 0
        if inst.LocalTransparencyModifier ~= nil then 
            inst.LocalTransparencyModifier = 1 
        end

        -- Processar descendentes de forma otimizada
        local descendants = inst:GetDescendants()
        for i = 1, #descendants do
            local d = descendants[i]
            
            if d:IsA("SurfaceAppearance") or d:IsA("Decal") or d:IsA("Texture")
            or d:IsA("SpecialMesh") or d:IsA("ParticleEmitter") or d:IsA("Trail")
            or d:IsA("Beam") or d:IsA("PointLight") or d:IsA("SpotLight")
            or d:IsA("SurfaceLight") or d:IsA("Fire") or d:IsA("Smoke")
            or d:IsA("Sparkles") or d:IsA("Sound") then
                pcall(function() d:Destroy() end)
            elseif d:IsA("MeshPart") then
                pcall(function()
                    d.TextureID = ""
                    d.RenderFidelity = Enum.RenderFidelity.Performance
                    d.Color = Color3.fromRGB(163,162,165)
                    d.Material = Enum.Material.Plastic
                    d.Transparency = 1
                    d.CastShadow = false
                end)
            end
        end

        -- Remover constraints desnecessários
        local children = inst:GetChildren()
        for i = 1, #children do
            local c = children[i]
            if c:IsA("HingeConstraint") or c:IsA("BallSocketConstraint") or c:IsA("RodConstraint")
            or c:IsA("SpringConstraint") or c:IsA("RopeConstraint") or c:IsA("WeldConstraint")
            or c:IsA("Motor6D") then
                pcall(function() c:Destroy() end)
            end
        end

        pcall(function() CollectionService:AddTag(inst, WALL_TAG) end)
    end)
end

local function ultraSoftWalls()
    if not ENABLE_NO_WALLS then return end
    local t = tick()
    if t - lastWallScan < ULTRA_PERFORMANCE.WALL_SCAN_INTERVAL then return end
    lastWallScan = t

    local descendants = workspace:GetDescendants()
    local processedThisFrame = 0
    local maxPerFrame = ULTRA_PERFORMANCE.MAX_PROCESSED_PER_FRAME
    
    for i = 1, #descendants do
        if processedThisFrame >= maxPerFrame then break end
        
        local inst = descendants[i]
        if inst:IsA("BasePart") and not CollectionService:HasTag(inst, WALL_TAG) then
            local n = inst.Name or ""
            if strContainsAny(n, WALL_KEYWORDS) then
                ultraProcessPart(inst)
                processedThisFrame = processedThisFrame + 1
            end
        end
    end
end

-- ===== ESP / HIGHLIGHT / RING =====
local function ensureHighlight(character)
    local hl = character:FindFirstChild("BrainhotESP_Highlight")
    if not hl then
        hl = Instance.new("Highlight")
        hl.Name = "BrainhotESP_Highlight"
        hl.FillColor = BH_FILL_COLOR
        hl.OutlineColor = BH_OUTLINE_COLOR
        hl.FillTransparency = BH_FILL_TRANSP
        hl.OutlineTransparency = BH_OUTLINE_TRANSP
        hl.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
        hl.Parent = character
    end
    return hl
end

-- Círculo vermelho (cilindro fininho) no HumanoidRootPart
local function ensureRing(character)
    local hrp = character:FindFirstChild("HumanoidRootPart")
    if not hrp then return end
    local ring = hrp:FindFirstChild("Sonin_RedRing")
    if not ring then
        ring = Instance.new("CylinderHandleAdornment")
        ring.Name = "Sonin_RedRing"
        ring.Radius = RING_RADIUS
        ring.Height = RING_HEIGHT
        ring.Color3 = RING_COLOR
        ring.Transparency = RING_TRANSP
        ring.Adornee = hrp
        ring.AlwaysOnTop = true
        ring.ZIndex = 5
        ring.Parent = hrp
    end
    return ring
end

local function ensureBillboard(head, value)
    local bb = head:FindFirstChild("BrainhotESP_BB")
    if not bb then
        bb = Instance.new("BillboardGui")
        bb.Name = "BrainhotESP_BB"
        bb.AlwaysOnTop = true
        bb.Size = UDim2.new(0, 200, 0, 40)
        bb.StudsOffset = Vector3.new(0, 2.5, 0)
        bb.Parent = head

        local label = Instance.new("TextLabel")
        label.Name = "Text"
        label.BackgroundTransparency = 1
        label.Size = UDim2.new(1, 0, 1, 0)
        label.Font = Enum.Font.SourceSansBold
        label.TextScaled = true
        label.TextColor3 = Color3.fromRGB(255,255,0)
        label.TextStrokeTransparency = 0.5
        label.Parent = bb
    end
    local t = bb:FindFirstChild("Text")
    if t then t.Text = "Brainhot: " .. tostring(value) end
    return bb
end

local function ultraSetupPerPlayerVisuals(plr)
    if plr == player then return end

    local function hookChar(char)
        if not char then return end

        ultraStripCharacter(char)

        if ENABLE_PLAYER_HIGHLIGHT then ensureHighlight(char) end
        if ENABLE_PLAYER_RING then ensureRing(char) end

        local head = safeGetHead(char)
        if ENABLE_BRAINHOT_ESP and head then
            task.spawn(function()
                local lastValue = 0
                local lastUpdate = 0
                while char.Parent and head.Parent do
                    local currentTime = tick()
                    if currentTime - lastUpdate >= ULTRA_PERFORMANCE.ESP_UPDATE_INTERVAL then
                        local value = getBrainhotValue(plr)
                        if value ~= lastValue then -- Só atualizar se o valor mudou
                            lastValue = value
                            if value >= BRAINHOT_LIMITE then
                                ensureHighlight(char)
                                ensureBillboard(head, value)
                                if ENABLE_PLAYER_RING then ensureRing(char) end
                            else
                                local bb = head:FindFirstChild("BrainhotESP_BB")
                                if bb then pcall(function() bb:Destroy() end) end
                                if not ENABLE_PLAYER_HIGHLIGHT then
                                    local hl = char:FindFirstChild("BrainhotESP_Highlight")
                                    if hl then pcall(function() hl:Destroy() end) end
                                end
                            end
                        end
                        lastUpdate = currentTime
                    end
                    task.wait(0.1) -- Verificação mais frequente mas processamento menos frequente
                end
            end)
        end
    end

    if plr.Character then hookChar(plr.Character) end
    plr.CharacterAdded:Connect(function(c) task.wait(0.1) hookChar(c) end)
    plr.CharacterAppearanceLoaded:Connect(hookChar)
end

for _, p in ipairs(Players:GetPlayers()) do ultraSetupPerPlayerVisuals(p) end
Players.PlayerAdded:Connect(ultraSetupPerPlayerVisuals)

-- ===== HEARTBEAT ULTRA OTIMIZADO COM FRAME SKIPPING =====
local hbCounter = 0
local lastMemoryCleanup = 0
local lastStripUpdate = 0

RunService.Heartbeat:Connect(function()
    -- Atualizar métricas de performance
    updatePerformanceMetrics()
    
    -- Frame skipping baseado na performance
    if ULTRA_PERFORMANCE.ENABLE_FRAME_SKIPPING then
        cache.skipFrames = cache.skipFrames + 1
        if cache.skipFrames < cache.maxSkipFrames then
            return -- Pular este frame
        end
        cache.skipFrames = 0
    end
    
    hbCounter += 1
    cache.frameCount += 1
    
    -- Limpeza de memória ultra otimizada
    if tick() - lastMemoryCleanup > ULTRA_PERFORMANCE.MEMORY_CLEANUP_INTERVAL then
        lastMemoryCleanup = tick()
        ultraMemoryCleanup()
    end
    
    if hbCounter >= 60 then -- ~1s
        hbCounter = 0

        -- Strip de skins com intervalo otimizado
        if ENABLE_STRIP_SKINS and tick() - lastStripUpdate > ULTRA_PERFORMANCE.STRIP_INTERVAL then
            lastStripUpdate = tick()
            local players = Players:GetPlayers()
            local processedThisFrame = 0
            local maxPerFrame = ULTRA_PERFORMANCE.MAX_PROCESSED_PER_FRAME
            
            for i = 1, #players do
                if processedThisFrame >= maxPerFrame then break end
                
                local p = players[i]
                if p ~= player and p.Character then
                    local children = p.Character:GetChildren()
                    for j = 1, #children do
                        local item = children[j]
                        if item:IsA("Accessory") or item:IsA("Hat")
                        or item:IsA("Shirt") or item:IsA("Pants")
                        or item:IsA("ShirtGraphic") then
                            pcall(function() item:Destroy() end)
                        end
                    end
                    
                    local descendants = p.Character:GetDescendants()
                    for k = 1, #descendants do
                        if processedThisFrame >= maxPerFrame then break end
                        
                        local part = descendants[k]
                        if part:IsA("BasePart") then
                            pcall(function()
                                part.Color = Color3.fromRGB(163,162,165)
                                part.CastShadow = false
                            end)
                            processedThisFrame = processedThisFrame + 1
                        end
                    end
                end
            end
        end

        if ENABLE_NO_WALLS then ultraSoftWalls() end
    end
end)

-- ===== OTIMIZAÇÕES ADICIONAIS =====
-- Otimizar configurações do jogo
pcall(function()
    -- Manter o mouse visível para melhor usabilidade
    game:GetService("UserInputService").MouseIconEnabled = true
    workspace.CurrentCamera.CameraType = Enum.CameraType.Custom
    workspace.CurrentCamera.FieldOfView = 70
end)

-- Otimizar configurações de renderização
pcall(function()
    local Lighting = game:GetService("Lighting")
    Lighting.GlobalShadows = false
    Lighting.ShadowSoftness = 0
    Lighting.ShadowMapSize = 0
    Lighting.Brightness = 1
    Lighting.Ambient = Color3.fromRGB(127,127,127)
    Lighting.OutdoorAmbient = Color3.fromRGB(127,127,127)
end)

-- ===== SISTEMA DE OTIMIZAÇÃO DE REDE =====
local function optimizeNetwork()
    pcall(function()
        -- Otimizar configurações de rede
        game:GetService("NetworkClient"):SetOutgoingKBPSLimit(math.huge)
        game:GetService("NetworkClient"):SetIncomingKBPSLimit(math.huge)
    end)
end
optimizeNetwork()

-- ===== SISTEMA DE MONITORAMENTO EM TEMPO REAL =====
local function printPerformanceStats()
    local fps = cache.avgFrameTime > 0 and math.floor(1/cache.avgFrameTime) or 0
    print(("[AntiLag ULTRA] FPS: %d | Mode: %s | Frames: %d | Cache: %d parts"):format(
        fps, 
        cache.performanceMode, 
        cache.frameCount,
        #cache.processedParts
    ))
end

-- Print stats a cada 10 segundos
task.spawn(function()
    while true do
        task.wait(10)
        printPerformanceStats()
    end
end)

print(("[AntiLag ULTRA] OK | highlight/ring ativos | lighting ultra limpo | no-walls %.1fs | cache ativo | frame-skipping ativo"):format(ULTRA_PERFORMANCE.WALL_SCAN_INTERVAL))
