-- FleischPanel Minimal — Kick + FPS/Ping (Top HUD) + Anti-Lag forte (client-side)
-- Seguro: sem wallhack/ESP/remotes abusivos.

-- ============ SERVICES ============
local Players          = game:GetService("Players")
local RunService       = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local TeleportService  = game:GetService("TeleportService")
local Lighting         = game:GetService("Lighting")
local TweenService     = game:GetService("TweenService")
local Stats            = game:GetService("Stats")
local GuiService       = game:GetService("GuiService")
local CollectionService= game:GetService("CollectionService")

local LocalPlayer = Players.LocalPlayer
local playerGui   = LocalPlayer:WaitForChild("PlayerGui")

-- ============ THEME (apenas para o painel) ============
local theme = "dark"
local palette = {
  dark = {
    BG = Color3.fromRGB(14,17,22), Stroke = Color3.fromRGB(70,70,100),
    Text = Color3.fromRGB(255,255,255), AccentBtn = Color3.fromRGB(24,28,36),
    AccentRed = Color3.fromRGB(170,35,45), AccentRedD = Color3.fromRGB(90,20,25),
    ToastBG = Color3.fromRGB(20,24,31)
  }
}
local function C(k) return palette[theme][k] end

-- ============ CONFIG ============
local ENABLE_SELF_KICK  = true
local SELF_KICK_KEY     = Enum.KeyCode.K
local SELF_KICK_MESSAGE = "Você foi removido pelo sistema de moderação.\n(Code: 268)"
local PERF_TAG          = "PerfTrimmed_v2"

-- ============ CLEANUP ============
for _,n in ipairs({"CmdUI","CmdUI_TopStats","Toast"}) do local g=playerGui:FindFirstChild(n); if g then g:Destroy() end end

-- ============ TOAST ============
local function quickToast(text)
  local gui = Instance.new("ScreenGui"); gui.Name="Toast"; gui.ResetOnSpawn=false; gui.IgnoreGuiInset=true; gui.Parent=playerGui
  local box = Instance.new("Frame"); box.Size=UDim2.new(0,360,0,64); box.AnchorPoint=Vector2.new(0.5,0); box.Position=UDim2.new(0.5,0,0.1,0)
  box.BackgroundColor3=C("ToastBG"); box.BorderSizePixel=0; box.Parent=gui
  Instance.new("UICorner", box).CornerRadius = UDim.new(0,10)
  local s = Instance.new("UIStroke", box); s.Thickness=1; s.Color=C("Stroke"); s.Transparency=0.3
  local lbl = Instance.new("TextLabel"); lbl.BackgroundTransparency=1; lbl.Size=UDim2.new(1,-20,1,-20); lbl.Position=UDim2.new(0,10,0,10)
  lbl.Text=text; lbl.TextColor3=C("Text"); lbl.Font=Enum.Font.GothamBold; lbl.TextSize=18; lbl.TextWrapped=true; lbl.Parent=box
  task.delay(1.05, function() if gui then gui:Destroy() end end)
end

-- ============ TOP HUD (FPS rainbow + Ping) ============
local topGui = Instance.new("ScreenGui")
topGui.Name = "CmdUI_TopStats"; topGui.ResetOnSpawn=false; topGui.DisplayOrder=1000
topGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling; topGui.Parent = playerGui

local function safeTopOffset()
  local tl = GuiService:GetGuiInset()
  return tl.Y + 6
end

local topFrame = Instance.new("Frame")
topFrame.AnchorPoint = Vector2.new(0.5,0)
topFrame.Position = UDim2.new(0.5,0,0,safeTopOffset())
topFrame.Size = UDim2.new(0,280,0,28)
topFrame.BackgroundTransparency = 1
topFrame.Parent = topGui

local topLayout = Instance.new("UIListLayout")
topLayout.FillDirection = Enum.FillDirection.Horizontal
topLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center
topLayout.VerticalAlignment = Enum.VerticalAlignment.Center
topLayout.Padding = UDim.new(0,10)
topLayout.Parent = topFrame

local function pill(text, bold)
  local l = Instance.new("TextLabel")
  l.Size = UDim2.new(0,130,1,-4); l.BackgroundTransparency = 0.35
  l.Text = text; l.TextColor3 = C("Text")
  l.Font = bold and Enum.Font.GothamBold or Enum.Font.Gotham
  l.TextSize = 14; l.TextXAlignment = Enum.TextXAlignment.Center
  l.BackgroundColor3 = Color3.fromRGB(25,28,35)
  Instance.new("UICorner", l).CornerRadius = UDim.new(0,8)
  local s = Instance.new("UIStroke", l); s.Thickness=1; s.Color=C("Stroke"); s.Transparency=0.35
  l.Parent = topFrame; return l
end

local fpsTop  = pill("FPS: --", true)   -- rainbow
local pingTop = pill("Ping: -- ms", false)

topGui:GetPropertyChangedSignal("AbsoluteSize"):Connect(function()
  topFrame.Position = UDim2.new(0.5,0,0,safeTopOffset())
end)

do
  local frames, last = 0, os.clock()
  RunService.RenderStepped:Connect(function()
    frames += 1
    local hue = (tick() * 0.15) % 1
    fpsTop.TextColor3 = Color3.fromHSV(hue, 1, 1) -- apenas FPS em rainbow
    if os.clock() - last >= 1 then
      fpsTop.Text = ("FPS: %d"):format(frames); frames = 0; last = os.clock()
      local pingVal
      pcall(function()
        local item = Stats and Stats.Network and Stats.Network.ServerStatsItem and Stats.Network.ServerStatsItem["Data Ping"]
        if item and item.GetValue then pingVal = math.floor(item:GetValue()) end
      end)
      pingTop.Text = pingVal and ("Ping: %d ms"):format(pingVal) or "Ping: -- ms"
    end
  end)
end

-- ============ ANTI-LAG (FORTALECIDO, CLIENT-SIDE) ============
local function applyUserGraphicsLow()
  pcall(function()
    local UserSettings = game:GetService("UserSettings")
    local UGS = UserSettings:GetService("UserGameSettings")
    UGS.GraphicsQualityLevel = 1
    -- manter RenderingMode padrão; forçar pode causar incompatibilidade em alguns dispositivos.
  end)
end

local function applyLightingLow()
  pcall(function()
    Lighting.GlobalShadows = false
    Lighting.ShadowSoftness = 0
    Lighting.Brightness = 1
    Lighting.Ambient = Color3.fromRGB(127,127,127)
    Lighting.OutdoorAmbient = Lighting.Ambient
    Lighting.FogStart = 0
    Lighting.FogEnd   = 1e6
    Lighting.EnvironmentSpecularScale = 0
    Lighting.EnvironmentDiffuseScale  = 0
    -- Desativa post-effects sem destruir (mais seguro)
    for _,eff in ipairs(Lighting:GetChildren()) do
      if eff:IsA("BlurEffect") or eff:IsA("BloomEffect") or eff:IsA("ColorCorrectionEffect")
        or eff:IsA("DepthOfFieldEffect") or eff:IsA("SunRaysEffect") then
        eff.Enabled = false
      end
    end
  end)
end

local function applyTerrainLow()
  pcall(function()
    local Terrain = workspace:FindFirstChildOfClass("Terrain")
    if Terrain then
      Terrain.WaterReflectance = 0
      Terrain.WaterTransparency = 1
      Terrain.WaterWaveSize = 0
      Terrain.WaterWaveSpeed = 0
      Terrain.WaterColor = Color3.fromRGB(0,0,0)
    end
  end)
end

local function applyWorkspaceLow()
  pcall(function()
    workspace.StreamingEnabled = true
    -- tentar raios mais curtos (se existir)
    if workspace:FindFirstChild("StreamingMinRadius") then workspace.StreamingMinRadius = 32 end
    if workspace:FindFirstChild("StreamingTargetRadius") then workspace.StreamingTargetRadius = 64 end
  end)
end

local function trimInstance(inst)
  if not inst or not inst.Parent then return end
  if CollectionService:HasTag(inst, PERF_TAG) then return end
  -- Remoção/desativação de coisas pesadas
  if inst:IsA("ParticleEmitter") or inst:IsA("Trail") or inst:IsA("Beam")
    or inst:IsA("Fire") or inst:IsA("Smoke") or inst:IsA("Sparkles") then
    pcall(function() inst:Destroy() end)
  elseif inst:IsA("PointLight") or inst:IsA("SpotLight") or inst:IsA("SurfaceLight") then
    pcall(function() inst.Enabled = false end)
  elseif inst:IsA("SurfaceAppearance") then
    pcall(function() inst:Destroy() end)
  elseif inst:IsA("BasePart") then
    pcall(function()
      inst.CastShadow = false
      if inst:IsA("MeshPart") then
        local ok = pcall(function() inst.RenderFidelity = Enum.RenderFidelity.Performance end)
        if not ok then
          -- nada; algumas plataformas não expõem esta prop
        end
      end
    end)
  end
  pcall(function() CollectionService:AddTag(inst, PERF_TAG) end)
end

local function initialTrim()
  -- Varredura inicial em lotes para não travar
  task.spawn(function()
    local count = 0
    for _, inst in ipairs(workspace:GetDescendants()) do
      trimInstance(inst)
      count += 1
      if count % 600 == 0 then task.wait() end
    end
  end)
  -- Trim em Lighting também (por segurança, caso tenham efeitos fora das classes padrão)
  task.spawn(function()
    for _,inst in ipairs(Lighting:GetDescendants()) do
      if inst:IsA("SurfaceAppearance") then pcall(function() inst:Destroy() end) end
    end
  end)
  -- Novos objetos que nascerem
  workspace.DescendantAdded:Connect(trimInstance)
end

local function applyAntiLagAll()
  applyUserGraphicsLow()
  applyLightingLow()
  applyTerrainLow()
  applyWorkspaceLow()
  initialTrim()
end

applyAntiLagAll()

-- ============ PAINEL (apenas Kick) ============
local screenGui = Instance.new("ScreenGui")
screenGui.Name="CmdUI"; screenGui.ResetOnSpawn=false; screenGui.DisplayOrder=999
screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling; screenGui.Parent = playerGui

-- ancorado canto inferior direito (flutuante)
local MARGIN_X, MARGIN_Y = 0.02, 0.04
local frame = Instance.new("Frame")
frame.AnchorPoint=Vector2.new(1,1)
frame.Position=UDim2.fromSc
